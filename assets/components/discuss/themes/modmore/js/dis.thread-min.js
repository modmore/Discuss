$(function(){$(".dis-poll-refresh").hide();DIS.Thread.init();$(".m-dis-thread-type li").click(function(){var e=$(this).hasClass("current");if(!e){var t=$(".dis-thread-info li:visible"),n=$(".m-dis-thread-type li"),r=$($(this).data("target")),i=$(this);t.fadeOut("slow",function(){t.removeClass("current");n.removeClass("current");i.addClass("current");r.fadeIn("slow",function(){r.addClass("current")})})}})});DIS.Thread=function(){var e=DIS.config.postCount,t=1;return{init:function(){$("#dis-preview-btn").click(this.preview);$(".dis-message-write").click(this.message);$("#dis-message-preview").delegate(".dis-message-cancel","click",this.message);$(".dis-post-title").click(this.togglePost);$(".dis-post-author").click(this.toggleAuthor);$(".dis-post-remove").click(this.removePost);$(".quick-reply").click(this.quickReply);$(".dis-add-attachment").click(this.addAttachment);$(".dis-post-reply").click(this.quickQuote)},preview:function(e){e.preventDefault();var t=$(".dis-thread-form"),n=t.serialize()+"&action=thread/preview",r=$.extend({},DIS.baseAjax,{url:DIS.url,async:!1,data:n,type:"POST"}),r=$.ajax(r);$("#dis-message-preview").hide().html(r.responseText).fadeIn(80);SyntaxHighlighter&&SyntaxHighlighter.highlight();$(".dis-message-write").removeClass("selected");$(".dis-preview").addClass("selected");$("#overlay-20").fadeIn();return!1},message:function(){$(".dis-preview").removeClass("selected");$(".dis-message-write").addClass("selected");$("#dis-message-preview").fadeOut(80);$("#overlay-20").fadeOut();return!1},quickReply:function(){$.scrollTo($(".preview_toggle"),500);$("#dis-thread-message").focus();return!1},quickQuote:function(e){e.preventDefault();var t=$("#dis-thread-message").val(),n=$(this).parents("li.dis-post").data(),r=document.createElement("div");r.innerHTML=n.message;n.message=r.innerHTML;t=t+(t.length>0?"\n\n":"")+"[quote author="+n.author+" date="+n.date+"]"+n.message+"[/quote]";$("#dis-thread-message").val(t);$("html,body").animate({scrollTop:$(".dis-thread-form").position().top},500,function(){$("#dis-thread-message").focus()});return!1},pollPosts:function(){var t=$.extend({},DIS.baseAjax,{url:DIS.config.connector,data:{action:"web/post/pollRefresh",post:1,ctx:DIS.config.context},success:function(t){if(t.success==0){DIS._showError(t.message);return!1}var n=parseInt(t.message)-parseInt(e);if(n!=0){DIS.Thread.displayRefreshMessage(n);e=t.message}setTimeout("DIS.Thread.pollPosts();",DIS.config.pollingInterval);return!0}});$.ajax(t)},displayRefreshMessage:function(e){$(".dis-poll-refresh").html("There have been "+e+" new posts since you last reloaded. Please "+'<a href="javascript:void(0);" onclick="DIS.Thread.reloadThread();">click here</a> '+"to refresh.").fadeIn()},reloadThread:function(){var e=$.extend({},DIS.baseAjax,{url:DIS.config.connector,data:{action:"web/post/loadThread",post:1,ctx:DIS.config.context},success:function(e){if(e.success==0){DIS._showError(e.message);return!1}$("#dis-thread").hide().html(e.message).slideDown();$(".dis-poll-refresh").fadeOut();return!0}});$.ajax(e)},togglePost:function(){var e=$(this).attr("post");$("#dis-board-post-"+e).find("ol").slideToggle();$("#dis-thread-ct-"+e).slideToggle();$("#dis-post-author-"+e).slideToggle()},toggleAuthor:function(){$(this).find(".dis-sig-ct").slideToggle()},showReplyForm:function(){var e=$(this).closest(".dis-post").attr("id");e=e.replace(/dis-post-/,"");var t=$.extend({},DIS.baseAjax,{url:DIS.config.connector,data:{action:"web/post/replyForm",post:e,ctx:DIS.config.context},success:function(t){if(t.success==0){DIS._showError(t.message);return!1}$("#dis-post-reply-"+e).hide().html(t.message).slideDown();$("#dis-reply-form-"+e+" textarea").focus();return!0}});$.ajax(t)},hideReplyForm:function(e){$("#dis-post-reply-"+e).slideUp()},postReply:function(e){var t=$("#dis-reply-form-"+e),n=t.serialize()+"&action=web/post/reply&ctx="+DIS.config.context,r=$.extend({},DIS.baseAjax,{url:DIS.config.connector,data:n,success:function(t){if(t.success==0){DIS._showError(t.message);return!1}var n=$("#dis-board-post-"+e).children("ol");n.length>0?n.append(t.message):$("#dis-board-post-"+e).append('<ol class="dis-board-thread">'+t.message+"</ol>");var r=parseInt($(".dis-author-post-count").html());$(".dis-author-post-count").html(r+1);DIS.Thread.hideReplyForm(e);DIS.Thread.init();return!0}});$.ajax(r)},removePost:function(){var e=$.q($(this).attr("href"));e.id=$(this).closest(".dis-post").attr("id");e.id=e.id.replace(/dis-post-/,"");return confirm("Are you sure you want to remove this post?")},addAttachment:function(){var e=$("#dis-attachments"),n=t+1;if(n>DIS.config.attachments_max_per_post)return!1;var r='<label><span>&nbsp;</span></label><input type="file" name="attachment'+n+'" /><br class="clear" />';e.append(r);t+=1;return!1}}}();